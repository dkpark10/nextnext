import type { GetServerSideProps } from "next";
import Head from "next/head";
import React, { useEffect, useRef, useState } from "react";
import { useMutation, dehydrate, QueryClient, useQuery, useQueryClient } from "@tanstack/react-query";
import { getTodo, createTodo, updateTodo } from "@/services";
import ModalContainer from "@/components/modal";
import EditModalContent from "@/components/edit-todo";
import { Todo } from "global-type";

export default function NextNext() {
  const queryClient = useQueryClient();

  const inputRef = useRef<HTMLInputElement>(null);
  const [showModal, setShowModal] = useState(false);
  const [inputValue, setInputValue] = useState("");
  const [currentTodoItem, setCurrentTodoItem] = useState<Todo["id"] | null>(null);

  const { data: todoList, isError, isLoading } = useQuery(["todo"], getTodo);

  const { mutate: updateMutate } = useMutation((newTodo: Todo) => updateTodo(newTodo));

  const onSubmit = (e: React.FormEvent<HTMLFormElement>) => {
    if (!todoList) return;
    e.preventDefault();
  };

  const onClickEditShowModal = (todoId: Todo["id"]) => () => {
    setShowModal(true);
    setCurrentTodoItem(todoId);
    setInputValue(todoList?.find((todoItem) => todoItem.id === todoId)?.title || "");
  };

  useEffect(() => {
    // eslint-disable-next-line no-console
    console.log(process.env.NEXT_PUBLIC_BASE_URL);
  }, []);

  return (
    <>
      <Head>
        <title>nextnext</title>
        <meta name="description" content="Generated by create next app" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <link rel="icon" href="/favicon.ico" />
      </Head>
      <div>
        {showModal && (
          <ModalContainer>
            <EditModalContent
              todoTitle={inputValue}
              onChange={(e: React.ChangeEvent<HTMLInputElement>) => {
                setInputValue(e.target.value);
              }}
              onCloseModal={() => {
                setShowModal(false);
                setCurrentTodoItem(null);
                setInputValue("");
                updateMutate({
                  title: inputValue,
                  id: currentTodoItem as Todo["id"],
                  isCompleted: false,
                });
              }}
            />
          </ModalContainer>
        )}

        <header className="text-center text-2xl py-2">Next Next</header>
        <main>
          <form onSubmit={onSubmit}>
            <div className="flex justify-center p-4 gap-2 w-full">
              <input
                className="outline-none rounded px-0.5 shadow-md w-full h-8"
                tabIndex={0}
                type="text"
                ref={inputRef}
              />
              <button className="bg-indigo-700 rounded-md w-12 shadow-lg text-white" type="button">
                추가
              </button>
            </div>
          </form>

          {todoList?.map((todo) => (
            <div className="flex justify-center p-2 gap-1 items-center shadow-md" key={todo.id}>
              <input type="checkbox" />
              <div className="px-1">
                <p className="flex items-center overflow-hidden text-ellipsis h-8 w-64 whitespace-nowrap">
                  {todo.title}
                </p>
              </div>
              <div className="flex gap-1">
                <button
                  type="button"
                  className="bg-teal-300 rounded-md w-9 shadow-lg text-white"
                  onClick={onClickEditShowModal(todo?.id)}
                >
                  수정
                </button>
                <button type="button" className="bg-red-600 rounded-md w-9 shadow-lg text-white">
                  삭제
                </button>
              </div>
            </div>
          ))}
        </main>
      </div>
    </>
  );
}

export const getServerSideProps: GetServerSideProps = async () => {
  const queryClient = new QueryClient();
  await queryClient.prefetchQuery(["todo"], getTodo);

  return {
    props: {
      dehydratedState: dehydrate(queryClient),
    },
  };
};
